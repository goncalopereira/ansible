# bootstrap.yml
 
---
- hosts: all
  vars:
  - ubuntu_release: raring
  - logwatch_email: ansibletest@goncalopereira.com
 
  tasks:
  - name: Update APT package cache
    action: apt update_cache=yes
 
  - name: Upgrade APT to the lastest packages
    action: apt upgrade=dist

  - name: Add deployment user
    action: user name=deploy
 
  - name: Add authorized deploy key
    action: authorized_key user=deploy key='$FILE(config/id_rsa.pub)'
 
  - name: Remove sudo group rights
    action: lineinfile dest=/etc/sudoers regexp="^%sudo" state=absent
 
  - name: Add deploy user to sudoers
    action: lineinfile dest=/etc/sudoers regexp="deploy ALL" line="deploy ALL=(ALL) NOPASSWD:ALL" state=present
 
  - name: Disallow password authentication
    action: lineinfile dest=/etc/ssh/sshd_config regexp="^PasswordAuthentication" line="PasswordAuthentication no" state=present
    notify: Restart ssh
 
  - name: Install unattended-upgrades
    action: apt pkg=unattended-upgrades state=present
 
  - name: Adjust APT update intervals
    action: copy src=config/apt_periodic dest=/etc/apt/apt.conf.d/10periodic
 
  - name: Make sure unattended-upgrades only installs from $ubuntu_release-security
    action: lineinfile dest=/etc/apt/apt.conf.d/50unattended-upgrades regexp="$ubuntu_release-updates" state=absent
 
  - name: Install logwatch
    action: apt pkg=logwatch state=installed
 
  - name: Make logwatch mail $logwatch_email daily
    action: lineinfile dest=/etc/cron.daily/00logwatch regexp="^/usr/sbin/logwatch" line="/usr/sbin/logwatch --output mail --mailto $logwatch_email --detail high" state=present create=yes
 
  - name: Install ufw
    action: apt pkg=ufw state=installed

  - name: Setup ufw
    action: shell ufw allow 22/tcp
 
  - name: Setup ufw
    action: shell ufw allow 443/tcp
 
  - name: Setup ufw
    action: shell ufw allow 60023/udp
 
  - name: Enable ufw
    action: shell echo 'y' | ufw enable
 
  handlers:
  - name: Restart ssh
    action: service name=ssh state=restarted
