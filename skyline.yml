- hosts: all
  vars_files: 
  - roles/common/vars/graphite.yml
  - roles/common/vars/skyline.yml

  tasks:
    - name: Install tools
      action: apt pkg={{ item.name }} state=installed
      with_items: 
        - { name: python-dev }
        - { name: python-pip }
        - { name: git }

    - name: Checkout Skyline 
      action: git repo={{ skyline.repo }} dest={{ skyline.path }} version={{ skyline.version }}

    - name: Create Skyline log directories
      action: file path={{ item }} state=directory
      with_items: [ /var/log/skyline, /var/run/skyline ]

    - name: Install {{ skyline.path }}/requirements.txt with pip
      action: pip requirements={{ skyline.path }}/requirements.txt

    - name: Install remaining dependencies with pip
      action: pip name={{ item.name }} version={{ item.version }}
      with_items:
        - { name: patsy, version: 0.2.1 }
        - { name: msgpack_python, version: 0.4.0 }

    - name: Install python dependencies
      action: apt pkg={{ item.name }} state=installed
      with_items: 
        - { name: python-numpy }
        - { name: python-scipy }
        - { name: python-scikits.statsmodels }

    - name: Install redis
      action: apt pkg={{ redis_server.name }}={{ redis_server.version }} state=installed
      notify: restart redis

    - name: Update redis.conf
      action: copy src=roles/skyline/files/redis.conf dest=/etc/redis/redis.conf
      notify: restart redis

    - name: Update Skyline settings.py template
      template: src=roles/skyline/templates/settings.py.j2 dest={{ skyline.path }}/src/settings.py
      notify: 
        - restart skyline

    - name: Update skyline init.d templates
      template: src=roles/skyline/templates/init.d.j2 dest=/etc/init.d/{{ item }}
      with_items: [ horizon.d, analyzer.d, webapp.d ]
      notify: 
      - make skyline init.d executable
      - restart skyline

  handlers:
    - name: restart redis
      action: service name={{ redis_server.name }} state=restarted
  
    - name: make skyline init.d executable
      action: file path=/etc/init.d/{{ item }} mode=555
      with_items: [ horizon.d, analyzer.d, webapp.d ]

    - name: restart skyline
      action: service name={{ item }} state=restarted
      with_items: [ horizon.d, analyzer.d, webapp.d ]
